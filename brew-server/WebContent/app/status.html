<!DOCTYPE html>
<html>
<meta charset="utf-8"/>
<head>
<title>Brew Controller Status</title>
<style type="text/css">
img.statusIcon {
	height: 50px;
	width: 50px;
}
.potImage { 
   position: relative; 
   width: 100%; /* for IE 6 */
}

.potTemp { 
   position: absolute; 
   top: 85px; 
   left: 25px; 
   width: 100%; 
}

.imageContainer {
       width:100px; 
       height:150px; 
       background-image: url(../theme/pot.png);
 }
</style>
<script type="text/javascript" src="../scripts/Chart.bundle.js"></script>
<script type="text/javascript">

var contextPath = document.location.href;
var posStart = contextPath.indexOf("/",  contextPath.indexOf("/") + 2);
var posEnd = contextPath.indexOf("/", posStart + 1);
contextPath = contextPath.substring(posStart, posEnd);
if (contextPath.substring(0,4) == "/app") {
	contextPath = "";
}

function loadStatus() {
	var r = new XMLHttpRequest();
	r.open("GET", contextPath + "/v1/api/states/system", true);
	r.onreadystatechange = function() {
		if (r.readyState != 4 || r.status != 200) {
			return;
		}
		var statusData = JSON.parse(r.responseText);
		
		setLinkedPngImage("icon_stirrer", statusData.stirrer, "motor_", "ON / OFF");
		setLinkedPngImage("icon_heater_1", statusData.heaters[0], "heater_", "ON / OFF");
		setLinkedPngImage("icon_heater_2", statusData.heaters[1], "heater_", "ON / OFF");
		setValue("temperature1", statusData.temperatures[0].value, "°C");
		setLink("temperature1_icon", statusData.temperatures[0].id, "Temperature [°C]");
		setValue("temperature2", statusData.temperatures[1].value, "°C");
		setLink("temperature2_icon", statusData.temperatures[1].id, "Temperature [°C]");
		setValue("avgTemp", statusData.avgTemp, "°C");
		setLink("temperatureAvg_icon", "Average", "Temperature [°C]");
		setValue("time", statusData.timeString);
		if (statusData.stirrerRunning) {
			setValue("rotationSpeed", statusData.rotation, "U/min");
		} else {
			setValue("rotationSpeed", "");
		}
	};
	r.send();
}

function setLinkedPngImage(id, relay, imageprefix, labelString) {
	setPngImage(id, relay.isOn, imageprefix);
	setLink(id, relay.id, labelString);
}

function setPngImage(id, booleanValue, imageprefix) {
	var imageFile = imageprefix;
	if (booleanValue) {
		imageFile += "ON";
	} else {
		imageFile += "OFF";
	}
	imageFile += ".png";
	setImage(id, imageFile);
}

function setImage(id, imageFile) {
	document.getElementById(id).src = "../theme/" + imageFile;
}

function setLink(id, componentId, labelString) {
	document.getElementById(id).onclick = function(){ drawChart(componentId , labelString); };
}
	
function setValue(id, text, scale) {
	if (text != null) {
		if (scale != null) {
			text += "&nbsp;" + scale;
		}
		document.getElementById(id).innerHTML = text;
	}
}
	
</script>
<script>

var myChart;

function drawChart(componentId, labelString) {
	 var r = new XMLHttpRequest();
		r.open("GET", contextPath + "/v1/api/states/chartData?componentId=" + componentId, true);
		r.onreadystatechange = function() {
			if (r.readyState != 4 || r.status != 200) {
				return;
			}
			var chartData = JSON.parse(r.responseText);
			
			 var ctx = document.getElementById("myChart");
			 var config = {
			            type: 'line',
			            data: {
			                labels: chartData.labels,
			                datasets: [{
			                    label: labelString,
			                    data: chartData.data,
			                    fill: false,
			                }]
			            },
			            options: {
			                responsive: false,
			            }
			        }; 
			if (myChart != null) {
				myChart.destroy();
			} 
			myChart = new Chart(ctx,config);
		};
		r.send();
 }
</script>
</head>
<body onload="loadStatus();setInterval(loadStatus, 2500);">
	<p>Status from <span id="time"></span>:</p>
	<br/>
	<table>
		<tr>
		<td>
			<table>
				<tr>
					<td></td>
					<td colspan="2" align="center"><span id="rotationSpeed"></span><br /></td>
					<td></td>
				</tr>
				<tr>
					<td></td>
					<td colspan="2" align="center">
						<img id="icon_stirrer" class="statusIcon" src=""/>
					</td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td></td>
					<td colspan="2" rowspan="2">
						<div class="potImage">
							<img src="../theme/pot.png"  id="temperatureAvg_icon" onclick="" alt="" width="100px" height="150"/>
							<span class="potTemp"><span id="avgTemp"></span></span>
						</div>
					</td>
					<td><img id="temperature1_icon" class="statusIcon" onclick="" src="../theme/thermometer.png" /><br />&nbsp;<span id="temperature1"></span></td>
				</tr>
				<tr>
					<td><img id="temperature2_icon" class="statusIcon" onclick="" src="../theme/thermometer.png" /><br /><span id="temperature2"></span></td>
					<td></td>
				</tr>
				<tr>
					<td></td>
					<td><img id="icon_heater_1" class="statusIcon" src="" /></td>
					<td><img id="icon_heater_2" class="statusIcon" src="" /></td>
					<td></td>
				</tr>
			</table>
		</td>
		<td><canvas id="myChart" width="500" height="500"></canvas></td>
		</tr>
	</table>
</body>
</html>